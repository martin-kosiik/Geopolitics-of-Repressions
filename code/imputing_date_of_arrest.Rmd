---
title: "Imputing date of arrest"
author: "Martin Kosík"
date: "10 března 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("pscl")
library(pscl)
library(broom)
install.packages("rstanarm")
library(rstanarm)
```

Checkout GLMMadaptive 
```{r}
some_date <-  memorial_lists %>% 
  filter(no_date == 0) %>% 
  mutate(MONTH_PROCESS_simple_imp = ifelse(is.na(MONTH_PROCESS),
                                           base::sample(1:12, size = 1, prob = rep(1/12, 12)),
                                           MONTH_PROCESS),
         DAY_PROCESS_simple_imp = ifelse(is.na(DAY_PROCESS),
                                           case_when(MONTH_PROCESS_simple_imp %in% c(1, 3, 5, 7, 8, 10, 12) ~ 
                                                       base::sample(1:31, size = 1, prob = rep(1/31, 31)),
                                                     MONTH_PROCESS_simple_imp %in% c(4, 6, 9, 11) ~ 
                                                       base::sample(1:30, size = 1, prob = rep(1/30, 30)),
                                                     MONTH_PROCESS_simple_imp == 2 ~
                                                       base::sample(1:28, size = 1, prob = rep(1/28, 28))),
                                           DAY_PROCESS))
  

memorial_lists %>% 
  count(arest_date, sort = T)

missing_month_not_year <-  memorial_lists %>% 
  filter(is.na(MONTH_PROCESS) & !is.na(YEAR_PROCESS)) %>% 
  filter(YEAR_PROCESS >1920, YEAR_PROCESS < 1961)


  

non_missing_process_mon_year <- memorial_lists %>% 
  filter(!is.na(MONTH_PROCESS) & !is.na(YEAR_PROCESS)) %>%
  filter(YEAR_PROCESS >1920, YEAR_PROCESS < 1961) %>% 
  mutate(MONTH_PROCESS =as.factor(MONTH_PROCESS),
         YEAR_PROCESS =as.factor(YEAR_PROCESS)) %>% 
  dplyr::select(MONTH_PROCESS, YEAR_PROCESS)

nb_month <- NaiveBayes(as.factor(MONTH_PROCESS) ~ as.factor(YEAR_PROCESS), data = non_missing_process_mon_year)

preds <- predict(nb_month, data = missing_month_not_year)

head(preds$posterior)

missing_month_not_year$MONTH_PROCESS_imp <- map_dbl(1:nrow(missing_month_not_year),
                                                    ~ base::sample(1:12, size = 1, prob = preds$posterior[., ]))



both_dates <- some_date %>% 
  filter((!is.na(MONTH)) & (!is.na(MONTH_PROCESS))) %>% 
  mutate(date_arrest = parse_date_time(arest_date, "dmy"), 
         date_process = parse_date_time(process_date, "dmy")) %>% 
  filter(!(is.na(date_arrest) | is.na(date_process))) %>% 
  mutate(diff_days = interval(date_arrest, date_process) / ddays(1)) %>% 
  filter(YEAR_PROCESS >1920, YEAR_PROCESS < 1961) %>% 
  filter(diff_days >= 0)
  




missing_day <- memorial_lists %>% 
  filter((!is.na(MONTH)) & (!is.na(MONTH_PROCESS))) %>% 
  mutate(date_arrest = parse_date_time(arest_date, "dmy"), 
         date_process = parse_date_time(process_date, "dmy")) %>% 
  

  

glm_model <-  glm(log(1 +diff_days) ~ 1, data = filter(both_dates, diff_days >= 0))

lm_model <-  lm(log(1 +diff_days) ~ as.factor(YEAR_PROCESS), data = both_dates)
glm_model <-  glm(log(1 +diff_days) ~ as.factor(YEAR_PROCESS), family = gaussian, data = both_dates)

stan_glm_model <-  stan_glm(log(1 +diff_days) ~ as.factor(YEAR_PROCESS), family = gaussian, data = both_dates)
stan_lm_model <-  stan_glm(log(1 +diff_days) ~ as.factor(YEAR_PROCESS), data = both_dates)
```


```{r}
lm_model_simple <-  lm(log(1 +diff_days) ~ 1, data = both_dates)
lm_model_simple_intercept <- lm_model_simple$coefficients[[1]]
lm_model_simple_sigma <- summary(lm_model_simple)$sigma
```

```{r}
missing_date_of_arrest <- some_date %>% 
  filter(is.na(YEAR) & !is.na(YEAR_PROCESS)) %>% 
  dplyr::select(person_id) %>% 
  mutate(diff_day_imp = round(exp(rnorm(n(), mean = lm_model_simple_intercept, sd = lm_model_simple_sigma)) - 1),
         diff_day_imp = ifelse(diff_day_imp < 0, 0, diff_day_imp))


some_date <- some_date %>% 
  left_join(missing_date_of_arrest, by = "person_id") %>% 
  mutate(date_process_simple_imp = as_date(str_c(YEAR_PROCESS, MONTH_PROCESS_simple_imp, DAY_PROCESS_simple_imp,
                                         sep = "-")),
         date_arrest_simple_imp = date_process_simple_imp - days(diff_day_imp),
         year_arrest_simple_imp = year(date_arrest_simple_imp), 
         source_date_arrest = case_when(!is.na(YEAR) ~ "label",
                                        !is.na(year_arrest_simple_imp) ~ "prediction",
                                        TRUE ~ "missing"),
         YEAR = ifelse(!is.na(year_arrest_simple_imp), year_arrest_simple_imp, YEAR)) 



some_date <- some_date %>% 
  filter(source_date_arrest != "missing") %>% 
  dplyr::select(person_id, YEAR, source_date_arrest)

saveRDS(some_date, file = here::here("data/arrest_date_imputation.RData"))


```

```{r}
coef_sims <- crossing(tidy(lm_model), sim_num = 1:1000) %>% 
  mutate(coef = rnorm(n(), mean = estimate, sd = std.error)) 


zip_model <-  zeroinfl(diff_days ~ 1, data = filter(both_dates, diff_days >= 0), dist = "negbin")

head(predict(zip_model))

summary(zip_model)

zip_function <- function(x, pi = exp(zip_model$coefficients$zero)/(1 + exp(zip_model$coefficients$zero)),
                         lambda = exp(zip_model$coefficients$count)){
  ifelse(x == 0, pi + (1 - pi) * exp(1)^(- lambda),
  (1 - pi) * (exp(1)^(- lambda) * lambda^x )/ factorial(x))
}

zip_function <- function(x, pi = exp(zip_model$coefficients$zero)/(1 + exp(zip_model$coefficients$zero)),
                         lambda = exp(zip_model$coefficients$count)){
  ifelse(x == 0, pi + (1 - pi) * exp(1)^(- lambda),
  (1 - pi) * dpois(x, lambda = lambda))
}

zip_function(11)

lm_model$coefficients[1]

glm_model$deviance

pnorm(lm_model$coefficients)

lm_model$df.residual

summary(glm_model)
summary(lm_model)

 
pi_hat <- exp(zip_model$coefficients$zero)/(1 + exp(zip_model$coefficients$zero))

lambda_hat <- exp(zip_model$coefficients$count)


both_dates %>% 
  filter(abs(diff_days) < 5000) %>% 
  filter(diff_days >= 0) %>% 
  mutate(log_diff_days = log(1 + diff_days)) %>% 
  ggplot(aes(x = log_diff_days)) + geom_histogram(aes(y=..density..)) + 
    geom_density(aes(y=..density.., position="stack"), col = "red") +
    stat_function(fun = dnorm, args = list(mean = lm_model$coefficients[1], sd = summary(lm_model)$sigma), 
                  col = "blue", size=1.5) + 
  theme_minimal()

both_dates %>% 
  filter(abs(diff_days) < 5000) %>% 
  filter(diff_days >= 0) %>% 
  ggplot(aes(x = diff_days)) + geom_histogram(aes(y=..density..)) + 
    geom_density(aes(y=..density.., position="stack"), col = "red") +
    stat_function(fun = zip_function, args = list(pi  = pi_hat, lambda = lambda_hat), col = "blue", size=1.5) + 
  scale_x_log10()+
  theme_minimal()

zip_predictions <- tibble(x = 0:5000) %>% 
  mutate(zip_density = zip_function(x = x, pi = pi_hat, lambda = lambda_hat) * 100)

both_dates %>% 
  filter(abs(diff_days) < 5000) %>% 
  filter(diff_days >= 0) %>% 
  ggplot(aes(x = diff_days)) + geom_histogram(aes(y=..density..)) + 
    #geom_density(aes(y=..density.., position="stack"), col = "red") +
  scale_x_log10()+
  geom_line(data = zip_predictions, aes(x = x, y = zip_density), size = 1.5)+
  theme_minimal()

zip_function(150)

both_dates %>% 
  filter(abs(diff_days) < 5000) %>% 
  filter(diff_days >= 0) %>% 
  ggplot(aes(x = diff_days)) + geom_histogram(col = "white") + theme_bw() + scale_x_log10()

ggsave(here::here("plots/diff_days_hist.pdf"))

head(both_dates)

head(both_dates$diff_days)
```

