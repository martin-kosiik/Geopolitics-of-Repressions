---
title: "Synthetic control"
author: "Martin Kosík"
date: "14 února 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(lubridate)
library(stargazer)
library(here)
library(readxl)
library(gsynth)
library(Synth)
library(MSCMT)
library(kableExtra)
library(knitr)
library(gghighlight)
```

```{r}
ethnicity_controls <- read_excel(here::here("data/ethnicity_info.xlsx")) %>%
  mutate(ethnicity_id = as.numeric(1:n()),
         urb_rate_pct = urb_rate * 100)



min_by_q <- min_by_q  %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(post_german = german * ifelse(year_q_date >= "1933-03-01", 1, 0))

library(zoo)
min_by_q <- min_by_q %>% 
  mutate(year_q_form = as.yearqtr(year_q_date), 
         year_str_rep = str_replace(year_q, "\\.", "Q") ) 
```

```{r}
ethnicity_controls %>% 
  dplyr::select(ethnicity, pop_total, clad_sim, urb_rate_pct) %>% 
  kable("latex", booktabs = T, digits = 2, linesep = "", format.args = list(big.mark = " "),
        col.names = c("Ethnic group", "Total population", "Linguistic similarity to Russian", "Urbanization rate"),
        caption = "Pre-treatment characteristics of ethnic groups in the USSR for SC") %>%
  footnote(general = "Total population and urbanization rate of the ethnic group in the USSR is taken from 1926 census. The linguistic similarity to Russian is measured by the number of common nodes in the language tree (cladistic similarity).",
           threeparttable = T) %>% 
    write_file(here::here("tables/sc_predictors.tex"))


```


```{r}
min_by_month <- read_csv(here::here("data/cleaned_min_arrests_by_month.csv")) 

min_by_month <- min_by_month  %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(post_german = german * ifelse(date >= "1933-03-23", 1, 0)) %>% 
  dplyr::select(ym_chr, ethnicity, ethnicity_id, log_n, pop_total, clad_sim, urb_rate)


```


## MSCMT implementation
### Quarterly observations 
```{r}
data_prep_mscmt <- listFromLong(as.data.frame(min_by_q), unit.variable = "ethnicity_id", 
                                time.variable="year_str_rep", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921Q1","1933Q1"))
times.pred <- cbind("pop_total"             = c("1921Q2","1932Q1"),
                    "clad_sim"              = c("1921Q2","1932Q1"),
                    "urb_rate"              = c("1921Q2","1932Q1"))

#agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```

```{r}
sc_results <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, single.v=TRUE)
improveSynth(data_prep, synth.out)
```

```{r}
ggplot(sc_results, type="comparison")
ggsave(here("plots/synthetic_control/comparison_plot.pdf"))
ggplot(sc_results, type="gap")
ggsave(here("plots/synthetic_control/gap.pdf"))
library(timetk)
timetk::tk_tbl(sc_results$combined$log_n) %>% 
  mutate(date = as_date(index)) %>% 
  gather("type", "log_n", treated, synth, -date) %>% 
  mutate(type = fct_recode(type, "Synthetic" = "synth", "Actual" = "treated") %>% 
           fct_relevel("Actual")) %>% 
  ggplot(aes(x = date, y = log_n, col = type)) + theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  annotate("rect", fill = "grey", alpha = 0.4, 
        xmin = as_date("1921-01-01"), xmax = as_date("1933-01-01"),
        ymin = -Inf, ymax = Inf) + 
   geom_line(size = 1) +
  scale_x_date(date_minor_breaks = "1 year", date_breaks = "5 year", date_labels = "%Y", 
               limits = c(as_date("1921-01-01"), NA)) +
  labs(x = element_blank(), y = "log(1 + arrests)", col = "German arrests") 

ggsave(here::here("plots/synthetic_control/comparison_plot.pdf"))


opts_current$set(label = "sc_weights")
tibble(ethnicity = names(sc_results$w), Weights = sc_results$w) %>% 
  filter(Weights != 0) %>% 
  arrange(desc(Weights)) %>% 
  kable("latex", booktabs = T, digits = 2, linesep = "", format.args = list(big.mark = " "),
        col.names = c("Ethnic group", "Weight"),
        caption = "Synthetic German minority weights") %>%
  #footnote(general = "Total population and urbanization rate of the ethnic group in the USSR is taken from 1926 census. The linguistic similarity to Russian is measured by the number of common nodes in the language tree (cladistic similarity).", threeparttable = T) %>% 
    write_file(here::here("tables/sc_weights.tex"))
  
  
```
placebo
```{r}
sc_placebo <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, placebo = TRUE, single.v=TRUE)

ggplot(sc_placebo, exclude.ratio=5, ratio.type="rmspe")
ggsave(here("plots/synthetic_control/placebo_gaps.pdf"))
ggplot(sc_placebo, exclude.ratio=100, ratio.type="mspe", type = "p.value", limits=c("1933-01-01", "1939-11-01"), 
       alternative= "two.sided")
ggsave(here("plots/synthetic_control/placebo_p_values.pdf"))

str(sc_placebo$placebo)

tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(index)) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 

ggsave(here("plots/synthetic_control/placebo_highlight_all.pdf"))


did(sc_placebo, "log_n", range.pre = c("1921Q1","1933Q1"),
    range.post = c("1933Q2","1939Q3"), exclude.ratio= 100, alternative="two.sided")

rmspe_placebo <- sc_placebo[-length(sc_placebo)] %>% 
  map("rmspe") %>% 
  map_dbl(1)

mspe_ratios <-  ppratio(sc_placebo, "log_n", range.pre = c("1921Q1","1933Q1"),
                        range.post = c("1933Q2","1939Q3"), type = "mspe")

tibble(mspe_ratios, ethnicity = names(mspe_ratios)) %>% 
  mutate(German = as.factor(ifelse(ethnicity == "German", "German", "Other"))) %>% 
  ggplot(aes(x = mspe_ratios, fill = German)) + geom_histogram() + theme_bw() +
  labs(x = "MSPE ratio",
      # title = "Ratios of post to pre-treatment period mean squared prediction error",
       fill = "Ethnic group")

ggsave(here::here("plots/synthetic_control/mspe_histogram.pdf"))


tibble(ethnicity = names(rmspe_placebo), rmspe_placebo) %>% 
  mutate(rmspe_german = rmspe_placebo[ethnicity == "German"],
         rmspe_5times = 5 * rmspe_german,
         rmspe_20times = 20 * rmspe_german)
  

str(last(sc_placebo))

str(sc_placebo)
```


### Monthly observations 

```{r}
data_prep_mscmt_monthly <- listFromLong(as.data.frame(min_by_month), unit.variable = "ethnicity_id", 
                                time.variable="ym_chr", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt_monthly[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921-05","1933-03"))
times.pred <- cbind("pop_total"             = c("1921-05","1932-01"),
                    "clad_sim"              = c("1921-05","1921-05"),
                    "urb_rate"              = c("1921-05","1921-05"))

agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```

```{r}
sc_results_monthly <- mscmt(data_prep_mscmt_monthly,
                            treatment.identifier = treatment.identifier, 
                            controls.identifier = controls.identifier, 
                            times.dep = times.dep,
                            times.pred = times.pred, 
                             agg.fns = agg.fns, seed=201,
                            debug = TRUE)
improveSynth(sc_results_monthly, synth.out)
```

```{r}
ggplot(sc_results_monthly, type="comparison")
ggsave(here("plots/synthetic_control/comparison_plot.pdf"))
ggplot(sc_results, type="gap")
ggsave(here("plots/synthetic_control/gap.pdf"))

```
placebo
```{r}
sc_placebo <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, single.v=TRUE, placebo = TRUE)

ggplot(sc_placebo, exclude.ratio=5, ratio.type="mspe")
ggsave(here("plots/synthetic_control/placebo_gaps.pdf"))
ggplot(sc_placebo, exclude.ratio=5, ratio.type="mspe", type = "p.value", limits=c("1933-01-01", "1939-11-01"), 
       alternative= "two.sided")
ggsave(here("plots/synthetic_control/placebo_p_values.pdf"))

did(sc_placebo, range.post = c("1933Q3","1939Q3"), exclude.ratio=5, alternative="two.sided")


```





```{r}
panelView(log_n ~ post_german  , data = min_by_q,  index = c("ethnicity","t")) 


out <- gsynth(log_n ~ post_german , data = min_by_q, parallel = FALSE, 
              index = c("ethnicity","t"), force = "two-way", se = TRUE, CV = TRUE, r=c(0,5),
              inference = "parametric", nboots = 5000) 

out_mc <- gsynth(log_n ~ post_german , data = min_by_q, parallel = FALSE, estimator = "mc",
              index = c("ethnicity","t"), force = "two-way", se = TRUE, CV = TRUE, r=c(0,5),
              inference = "parametric", nboots = 5000) 

print(out)
out$est.att
out$est.avg
out$est.beta
plot(out_mc, theme.bw = TRUE)


plot(out, theme.bw = TRUE)
plot(out, type = "raw", theme.bw = TRUE)
plot(out, type = "ct", raw = "none", shade.post = FALSE, theme.bw = TRUE)
plot(out, type = "counterfactual", raw = "all", shade.post = FALSE, theme.bw = TRUE)


data_prep <- dataprep(foo = as.data.frame(min_by_q), predictors =  c("pop_total", "clad_sim", "urb_rate"),
                      time.variable = c("t"), dependent = c("log_n"),
                      unit.variable = c("ethnicity_id"), 
                      treatment.identifier = 4, 
                      controls.identifier = c(1:3,5:17),
                      time.predictors.prior = c(1:49),
                      time.optimize.ssr =  c(1:49), 
                      time.plot = 1:156)

synth.out <- synth(data_prep)

synth.out$solution.w


path.plot(synth.out, data_prep)
abline(v=50, col="red")

gaps.plot(synth.out, data_prep)
abline(v=50, col="red")

synth.tab(synth.out, data_prep)


str(min_by_q)
data("basque")
basque %>% 
  count(regionno, regionname)

min_by_q %>% 
  count(ethnicity, ethnicity_id)
```

```{r}
cov.var <- c("pop_total", "clad_sim", "urb_rate")
match.out <- c("log_n")



micro_synth <- microsynth(min_by_q, 
                   idvar="ethnicity", timevar="t", intvar="post_german",
                   match.out = FALSE, match.covar = cov.var,
                   result.var=match.out, cut.mse = 20 * 0.004585003,
                   test="lower",  confidence = 0.95, 
                   perm=40, jack=F, use.survey = TRUE, 
                   check.feas=TRUE, use.backup=TRUE)

summary(micro_synth)
micro_synth$w

```

