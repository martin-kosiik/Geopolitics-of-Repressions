---
title: "Synthetic control"
author: "Martin Kosík"
date: "14 února 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(lubridate)
library(here)
library(readxl)
library(gsynth)
library(MSCMT)
library(kableExtra)
library(knitr)
library(gghighlight)
```

```{r}
ethnicity_controls <- read_excel(here::here("data/ethnicity_info.xlsx")) %>%
  mutate(ethnicity_id = as.numeric(1:n()),
         urb_rate_pct = urb_rate * 100)



min_by_q <- min_by_q  %>% 
  filter(ethnicity != "Russian") %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(post_german = german * ifelse(year_q_date >= "1933-03-01", 1, 0))

library(zoo)
min_by_q <- min_by_q %>% 
  mutate(year_q_form = as.yearqtr(year_q_date), 
         year_str_rep = str_replace(year_q, "\\.", "Q") ) %>% 
  dplyr::select(year_q_date, year_str_rep, ethnicity, ethnicity_id, log_n, pop_total, clad_sim, urb_rate)

```

```{r}
ethnicity_controls %>% 
  dplyr::select(ethnicity, pop_total, clad_sim, urb_rate_pct) %>% 
  kable("latex", booktabs = T, digits = 2, linesep = "", format.args = list(big.mark = " "),
        col.names = c("Ethnic group", "Total population", "Linguistic similarity to Russian", "Urbanization rate"),
        caption = "Pre-treatment characteristics of ethnic groups in the USSR for SC") %>%
  footnote(general = "Total population and urbanization rate of the ethnic group in the USSR is taken from 1926 census. The linguistic similarity to Russian is measured by the number of common nodes in the language tree (cladistic similarity).",
           threeparttable = T) %>% 
    write_file(here::here("tables/sc_predictors.tex"))


```


```{r}
min_by_month <- read_csv(here::here("data/cleaned_min_arrests_by_month.csv")) 

min_by_month <- min_by_month  %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(post_german = german * ifelse(date >= "1933-03-23", 1, 0)) %>% 
  dplyr::select(ym_chr, ethnicity, ethnicity_id, log_n, pop_total, clad_sim, urb_rate)


```

```{r}
min_by_year <-  read_csv(here::here("data/min_by_year_preds.csv")) %>% 
  filter(ethnicity != "Russian") %>% 
  dplyr::select(-c(pred_adj_full, total_pred_by_date, total_pred_adj, total_pred_adj_full,
                   total_pred, Sensitivity, Specificity)) %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(post_german = german * ifelse(YEAR >= 1933, 1, 0)) 

min_by_year <- min_by_year %>% 
  filter(YEAR < 1940)
```



## MSCMT implementation
### Quarterly observations 
```{r}
data_prep_mscmt <- listFromLong(as.data.frame(min_by_q), unit.variable = "ethnicity_id", 
                                time.variable="year_str_rep", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921Q1","1933Q1"))
times.pred <- cbind("pop_total"             = c("1921Q2","1932Q1"),
                    "clad_sim"              = c("1921Q2","1932Q1"),
                    "urb_rate"              = c("1921Q2","1932Q1"))

#agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```

### Annual observations 
```{r}
data_prep_mscmt <- listFromLong(as.data.frame(min_by_year), unit.variable = "ethnicity_id", 
                                time.variable="YEAR", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921","1933"))
times.pred <- cbind("pop_total"             = c("1921","19321"),
                    "clad_sim"              = c("1921","1932"),
                    "urb_rate"              = c("1921","1932"))

#agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```


```{r}
sc_results <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, single.v=TRUE)

sc_placebo <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, placebo = TRUE, single.v=TRUE)
```


```{r annual sc}
tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(str_c(index,"-01-01"))) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 


ggsave(here::here("plots/synthetic_control/ethnicity_imputation/annual/placebo_highlight_all.pdf"))

rmspe_placebo <- sc_placebo[-length(sc_placebo)] %>% 
  map("rmspe") %>% 
  map_dbl(1) 

rmspe_placebo_tibble <- tibble(ethnicity = names(rmspe_placebo), rmspe = rmspe_placebo) %>% 
  mutate(mspe = rmspe^2) %>% 
  mutate( mspe_german = mspe[ethnicity == "German"],
         mspe_5times_higher = ifelse(5 * mspe_german < mspe, 1, 0), 
         mspe_20times = ifelse(20 * mspe_german < mspe, 1, 0))

tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(str_c(index,"-01-01"))) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  left_join(rmspe_placebo_tibble, by = "ethnicity") %>% 
  filter(!mspe_5times_higher) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 

ggsave(here("plots/synthetic_control/ethnicity_imputation/annual/placebo_highlight_mspe_5_lower.pdf"))

mspe_ratios <-  ppratio(sc_placebo, "log_n", range.pre = c("1921Q1","1933Q1"),
                        range.post = c("1933Q2","1939Q3"), type = "mspe")


tibble(mspe_ratios, ethnicity = names(mspe_ratios)) %>%
  mutate(ethnicity = fct_reorder(ethnicity, mspe_ratios)) %>% 
  ggplot(aes(x = ethnicity, y = mspe_ratios))+ geom_col() + coord_flip() + theme_minimal() +
  labs(x = element_blank(), y = "MSPE ratio")

ggsave(here::here("plots/synthetic_control/ethnicity_imputation/annual/mspe_ratios.pdf"))

```



```{r}
ggplot(sc_results, type="comparison")
ggsave(here("plots/synthetic_control/comparison_plot.pdf"))
ggsave(here::here("plots/synthetic_control/ethnicity_imputation/annual/comparison_plot.pdf"))

ggplot(sc_results, type="gap")
ggsave(here("plots/synthetic_control/gap.pdf"))
ggsave(here::here("plots/synthetic_control/ethnicity_imputation/annual/gap.pdf"))

library(timetk)
timetk::tk_tbl(sc_results$combined$log_n) %>% 
  mutate(date = as_date(index)) %>% 
  gather("type", "log_n", treated, synth, -date) %>% 
  mutate(type = fct_recode(type, "Synthetic" = "synth", "Actual" = "treated") %>% 
           fct_relevel("Actual")) %>% 
  ggplot(aes(x = date, y = log_n, col = type)) + theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  annotate("rect", fill = "grey", alpha = 0.4, 
        xmin = as_date("1921-01-01"), xmax = as_date("1933-01-01"),
        ymin = -Inf, ymax = Inf) + 
   geom_line(size = 1) +
  scale_x_date(date_minor_breaks = "1 year", date_breaks = "5 year", date_labels = "%Y", 
               limits = c(as_date("1921-01-01"), NA)) +
  labs(x = element_blank(), y = "log(1 + arrests)", col = "German arrests") 

ggsave(here::here("plots/synthetic_control/comparison_plot.pdf"))
ggsave(here::here("plots/synthetic_control/ethnicity_imputation/quarterly/comparison_plot.pdf"))


opts_current$set(label = "sc_weights")
tibble(ethnicity = names(sc_results$w), Weights = sc_results$w) %>% 
  filter(Weights != 0) %>% 
  arrange(desc(Weights)) %>% 
  kable("latex", booktabs = T, digits = 2, linesep = "", format.args = list(big.mark = " "),
        col.names = c("Ethnic group", "Weight"),
        caption = "Synthetic German minority weights") %>%
  #footnote(general = "Total population and urbanization rate of the ethnic group in the USSR is taken from 1926 census. The linguistic similarity to Russian is measured by the number of common nodes in the language tree (cladistic similarity).", threeparttable = T) %>% 
    write_file(here::here("tables/sc_weights.tex"))
  
  
```
placebo
```{r}
sc_placebo <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, placebo = TRUE, single.v=TRUE)

ggplot(sc_placebo, exclude.ratio=5, ratio.type="rmspe")
ggsave(here("plots/synthetic_control/placebo_gaps.pdf"))
ggplot(sc_placebo, exclude.ratio=100, ratio.type="mspe", type = "p.value", limits=c("1933-01-01", "1939-11-01"), 
       alternative= "two.sided")
ggsave(here("plots/synthetic_control/placebo_p_values.pdf"))


tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(index)) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 


ggsave(here("plots/synthetic_control/placebo_highlight_all.pdf"))
ggsave(here("plots/synthetic_control/ethnicity_imputation/quarterly/placebo_highlight_all.pdf"))


did(sc_placebo, "log_n", range.pre = c("1921Q1","1933Q1"),
    range.post = c("1933Q2","1939Q3"), exclude.ratio= 100, alternative="two.sided")

rmspe_placebo <- sc_placebo[-length(sc_placebo)] %>% 
  map("rmspe") %>% 
  map_dbl(1) 

rmspe_placebo_tibble <- tibble(ethnicity = names(rmspe_placebo), rmspe = rmspe_placebo) %>% 
  mutate(mspe = rmspe^2) %>% 
  mutate( mspe_german = mspe[ethnicity == "German"],
         mspe_5times_higher = ifelse(5 * mspe_german < mspe, 1, 0), 
         mspe_20times = ifelse(20 * mspe_german < mspe, 1, 0))

tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(index)) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  left_join(rmspe_placebo_tibble, by = "ethnicity") %>% 
  filter(!mspe_5times_higher) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 


ggsave(here("plots/synthetic_control/placebo_highlight_mspe_5_lower.pdf"))
ggsave(here("plots/synthetic_control/ethnicity_imputation/quarterly/placebo_highlight_mspe_5_lower.pdf"))


tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  filter(index <= "1933Q1") %>% 
  gather("ethnicity", "log_n", -index) %>% 
  #select(-index) %>% 
  group_by(ethnicity) %>% 
  summarise(mspe = sqrt(mean(log_n^2)))

mspe_ratios <-  ppratio(sc_placebo, "log_n", range.pre = c("1921Q1","1933Q1"),
                        range.post = c("1933Q2","1939Q3"), type = "mspe")

tibble(mspe_ratios, ethnicity = names(mspe_ratios)) %>% 
  mutate(German = as.factor(ifelse(ethnicity == "German", "German", "Other"))) %>% 
  ggplot(aes(x = mspe_ratios, fill = German)) + geom_histogram() + theme_bw() +
  labs(x = "MSPE ratio",
      # title = "Ratios of post to pre-treatment period mean squared prediction error",
       fill = "Ethnic group")

ggsave(here::here("plots/synthetic_control/mspe_histogram.pdf"))

tibble(mspe_ratios, ethnicity = names(mspe_ratios)) %>%
  mutate(ethnicity = fct_reorder(ethnicity, mspe_ratios)) %>% 
  ggplot(aes(x = ethnicity, y = mspe_ratios))+ geom_col() + coord_flip() + theme_minimal() +
  labs(x = element_blank(), y = "MSPE ratio")

ggsave(here::here("plots/synthetic_control/mspe_ratios.pdf"))
ggsave(here::here("plots/synthetic_control/ethnicity_imputation/quarterly/mspe_ratios.pdf"))

str(last(sc_placebo))

str(sc_placebo)
```


### Monthly observations 

```{r}
data_prep_mscmt_monthly <- listFromLong(as.data.frame(min_by_month), unit.variable = "ethnicity_id", 
                                time.variable="ym_chr", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt_monthly[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921-05","1933-03"))
times.pred <- cbind("pop_total"             = c("1921-05","1932-01"),
                    "clad_sim"              = c("1921-05","1921-05"),
                    "urb_rate"              = c("1921-05","1921-05"))

agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```

```{r}
sc_results_monthly <- mscmt(data_prep_mscmt_monthly,
                            treatment.identifier = treatment.identifier, 
                            controls.identifier = controls.identifier, 
                            times.dep = times.dep,
                            times.pred = times.pred, 
                             agg.fns = agg.fns, seed=201,
                            debug = TRUE)
improveSynth(sc_results_monthly, synth.out)
```

```{r}
ggplot(sc_results_monthly, type="comparison")
ggsave(here("plots/synthetic_control/comparison_plot.pdf"))
ggplot(sc_results, type="gap")
ggsave(here("plots/synthetic_control/gap.pdf"))

```
placebo
```{r}
sc_placebo <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, single.v=TRUE, placebo = TRUE)

ggplot(sc_placebo, exclude.ratio=5, ratio.type="mspe")
ggsave(here("plots/synthetic_control/placebo_gaps.pdf"))
ggplot(sc_placebo, exclude.ratio=5, ratio.type="mspe", type = "p.value", limits=c("1933-01-01", "1939-11-01"), 
       alternative= "two.sided")
ggsave(here("plots/synthetic_control/placebo_p_values.pdf"))

did(sc_placebo, range.post = c("1933Q3","1939Q3"), exclude.ratio=5, alternative="two.sided")


```




```{r}
panelView(log_n ~ post_german  , data = min_by_q,  index = c("ethnicity","t")) 


out <- gsynth(log_n ~ post_german , data = min_by_q, parallel = FALSE, 
              index = c("ethnicity","t"), force = "two-way", se = TRUE, CV = TRUE, r=c(0,5),
              inference = "parametric", nboots = 5000) 

out_mc <- gsynth(log_n ~ post_german , data = min_by_q, parallel = FALSE, estimator = "mc",
              index = c("ethnicity","t"), force = "two-way", se = TRUE, CV = TRUE, r=c(0,5),
              inference = "parametric", nboots = 5000) 

plot(out, theme.bw = TRUE)
plot(out, type = "raw", theme.bw = TRUE)
plot(out, type = "ct", raw = "none", shade.post = FALSE, theme.bw = TRUE)
plot(out, type = "counterfactual", raw = "all", shade.post = FALSE, theme.bw = TRUE)

```

