---
title: "until pact version"
author: "Martin Kosík"
date: "28 února 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
min_by_q <- min_by_q  %>% 
  filter(year_q_date < ymd(19390823))
```

## MSCMT implementation
### Quarterly observations 
```{r}
data_prep_mscmt <- listFromLong(as.data.frame(min_by_q), unit.variable = "ethnicity_id", 
                                time.variable="year_str_rep", unit.names.variable="ethnicity")

```

```{r}
treatment.identifier <- "German"
controls.identifier  <- setdiff(colnames(data_prep_mscmt[[1]]),
                                 treatment.identifier)
times.dep  <- cbind("log_n"                 = c("1921Q1","1933Q1"))
times.pred <- cbind("pop_total"             = c("1921Q2","1932Q1"),
                    "clad_sim"              = c("1921Q2","1932Q1"),
                    "urb_rate"              = c("1921Q2","1932Q1"))

#agg.fns <- rep("mean", ncol(times.pred))                       
agg.fns <- rep("id", ncol(times.pred))
```

```{r}
sc_results <- mscmt(data_prep_mscmt, treatment.identifier, controls.identifier, times.dep, times.pred, agg.fns, seed=2019, single.v=TRUE)
improveSynth(data_prep, synth.out)
```

```{r}
library(timetk)
timetk::tk_tbl(sc_results$combined$log_n) %>% 
  mutate(date = as_date(index)) %>% 
  gather("type", "log_n", treated, synth, -date) %>% 
  mutate(type = fct_recode(type, "Synthetic" = "synth", "Actual" = "treated") %>% 
           fct_relevel("Actual")) %>% 
  ggplot(aes(x = date, y = log_n, col = type)) + theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  annotate("rect", fill = "grey", alpha = 0.4, 
        xmin = as_date("1921-01-01"), xmax = as_date("1933-01-01"),
        ymin = -Inf, ymax = Inf) + 
   geom_line(size = 1) +
  scale_x_date(date_minor_breaks = "1 year", date_breaks = "2 year", date_labels = "%Y", 
               limits = c(as_date("1921-01-01"), NA)) +
  labs(x = element_blank(), y = "log(1 + arrests)", col = "German arrests") 
ggsave(here::here("plots/synthetic_control/until_pact/comparison_plot.pdf"))

```

```{r}
tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(index)) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "1 year", date_breaks = "2 year", date_labels = "%Y") 

ggsave(here("plots/synthetic_control/until_pact/placebo_highlight_all.pdf"))

```


```{r}
rmspe_placebo <- sc_placebo[-length(sc_placebo)] %>% 
  map("rmspe") %>% 
  map_dbl(1) 

rmspe_placebo_tibble <- tibble(ethnicity = names(rmspe_placebo), rmspe = rmspe_placebo) %>% 
  mutate(mspe = rmspe^2) %>% 
  mutate( mspe_german = mspe[ethnicity == "German"],
         mspe_5times_higher = ifelse(5 * mspe_german < mspe, 1, 0), 
         mspe_20times = ifelse(20 * mspe_german < mspe, 1, 0))

tk_tbl(sc_placebo$placebo$log_n$gaps) %>% 
  mutate(date = as_date(index)) %>% 
  gather("ethnicity", "log_n", -c(date, index)) %>% 
  left_join(rmspe_placebo_tibble, by = "ethnicity") %>% 
  filter(!mspe_5times_higher) %>% 
  ggplot(aes(date, log_n, col = ethnicity)) + geom_line(size = 1)  + gghighlight(ethnicity == "German") +
  theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        #panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=12)) + 
  labs(x = element_blank(), y = "gaps in log(1 + arrests)") +
  geom_vline(xintercept= ymd(19330301), col = "black", linetype = "dashed", size = 1)+
    scale_x_date(date_minor_breaks = "2 year", date_breaks = "4 year", date_labels = "%Y") 

ggsave(here("plots/synthetic_control/until_pact/placebo_highlight_mspe_5_lower.pdf"))

```

