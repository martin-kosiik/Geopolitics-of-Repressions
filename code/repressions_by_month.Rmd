---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Load the necessary packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(lubridate)
library(stargazer)
library(here)
library(kableExtra)
library(estimatr)
library(multiwayvcov)
```


```{r}
load(here("data/eventsClean_v1.RData"))
```

```{r}
minorities_var_names <- names(events) %>% 
  str_subset("ETHNIC_")
```
We exclude Russians from vector of minorities
```{r}
minorities_var_names <- minorities_var_names[-1] 

```

```{r}
events <- events %>% 
  select(-c(NEAREST_RAIL_ID:LEVEL_SV)) %>% 
  mutate(date_ym = str_c(YEAR,  MONTH, 1, sep = "-"))

```

```{r}
min_by_month <- events %>%
  select(date_ym, ETHNIC_BEL:ETHNIC_CHECHEN) %>% 
  group_by_all() %>% 
  count() %>% 
  ungroup()


write_csv(min_by_month, here("data/min_arrests_by_month.csv"))


```

```{r}
min_by_month <- read_csv(here::here("data/min_arrests_by_month.csv"))

min_by_month <- min_by_month %>% 
  mutate(n_of_eth_gr = rowSums(.[2:18])) %>% 
  filter(n_of_eth_gr == 1) %>% 
  select(-n_of_eth_gr) %>% 
  gather(key= "ethnicity", value = "value", -c(date_ym, n)) %>% 
  filter(value == 1) %>% 
  select(-value)

```

```{r}
min_by_month <- min_by_month %>% 
  complete(date_ym, ethnicity, fill = list(n = 0)) %>% 
  filter(date_ym >= 1921) %>% 
  mutate(ethnicity = str_remove(ethnicity, "ETHNIC_"), 
         ethnicity = case_when(ethnicity == "BEL" ~ "Belarussian",
                               ethnicity == "GER" ~ "German",
                               ethnicity == "POL" ~ "Polish",
                               ethnicity == "UKR" ~ "Ukrainian",
                               TRUE ~ ethnicity) %>% 
                      str_to_title() %>% 
                      as.factor(),
         log_n = log(n + 1), 
         german = ifelse(ethnicity == "German", 1, 0))

```


```{r}
min_by_month <- min_by_month %>% 
  mutate(date = as_date(date_ym)) 
  
```
The key dates are:
1. Hitler becomes a dictator 1933-03-23
2. Molotov-Ribentropp pact is signed 1939-08-23
3. Operation Barbarossa is launched 1941-06-22 (we )
4. End of WWII in Europe 1945-05-08
```{r}
min_by_q <-  min_by_month %>% 
  mutate(year_q = quarter(date, with_year = T),
         year_q_date = floor_date(date, unit = "quarter"),
         year_q_decimal = decimal_date(year_q_date)) %>% 
  group_by(year_q, year_q_date, ethnicity, german) %>% 
  summarize(n = sum(n)) %>% 
  ungroup() %>% 
  mutate(log_n = log(n + 1)) %>% 
  group_by(ethnicity) %>% 
  mutate(t = row_number(), 
         hostility = ifelse(year_q_date >= "1933-03-23" & year_q_date <= "1939-08-23", 1, 0), 
         pact = ifelse(year_q_date > "1939-08-23" & year_q_date < "1941-06-22", 1, 0), 
         war = ifelse(year_q_date >= "1941-06-22" & year_q_date < "1945-05-08", 1, 0),
         post_war = ifelse(year_q_date >= "1945-05-08", 1, 0)) %>% 
  ungroup()
```

```{r}
year_quarters <- crossing(year = 1931:1937, quarter = 1:4) %>% 
  mutate(yq = str_c(year, quarter, sep = ".")) %>% 
  pull(yq)

post_yq_dummies <- map_dfc(year_quarters, ~  as.numeric(min_by_q$year_q >= .)) %>% 
  rename_all( funs( c(paste0("post_" ,year_quarters))))

min_by_q <-bind_cols(min_by_q, post_yq_dummies)

```

```{r}
fmla <- as.formula(paste("log_n ~ ", 
                         paste0("german:","post_", year_quarters, collapse = " + "),  "+ as.factor(year_q) +
                                                 ethnicity + t:ethnicity"))

fmla_window <- as.formula(paste("log_n ~ german:hostility + german:pact + german:war + as.factor(year_q) +
                         ethnicity + ethnicity:t"))


diff_model <- lm(fmla,  data = min_by_q)
diff_model_window <- lm(fmla_window,  data = min_by_q)

summary(diff_model_window)
```

```{r}
library(zoo)
diff_model %>% 
  broom::tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:post_","") %>% 
           str_replace("\\.", " Q") %>% 
           as.yearqtr() %>% 
           as.Date()) %>% 
  ggplot(mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
  geom_vline(xintercept= ymd(19330101), col = "red", linetype = "dashed") +
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_bw() + scale_x_date(date_minor_breaks = "1 year")+
  labs(x = "year", caption = "error bars show 95% confidence intervals",
       title = "Estimates on quarterly interactions of german*post")
ggsave(here("plots/did_effects_quarter.pdf"), width = 9, height = 6)

```


```{r}
did_effects_quart_line <- diff_model %>% 
  broom::tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:post_","") %>% 
           str_replace("\\.", " Q") %>% 
           as.yearqtr() %>% 
           as.Date()) %>% 
  ggplot(mapping = aes(x = nice_labs))+ 
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "grey70")+
  geom_line(aes(y = estimate), col = "black") +
  theme_bw() +  geom_hline(yintercept= 0, col = "black", linetype = "dashed") +
  scale_x_date(date_minor_breaks = "1 year") + 
  geom_vline(xintercept = ymd(19330101), color = "red") +
  labs(x = "year", caption = "the shaded ares shows 95% confidence intervals",
       title = "Estimates on quarterly interactions of german*post")

ggsave(here("plots/did_effects_quart_line.pdf"), plot = did_effects_quart_line, width = 9, height = 6)

```

```{r time window effects plot}
diff_model_window %>% 
  broom::tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:","")) %>% 
  ggplot(mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_minimal() +
  theme(axis.line = element_line(size = 1), 
        panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) + 
  labs(x = element_blank(), caption = "error bars show 95% confidence intervals",
       title = "Interactions of German ethnicity with specified time window dummy", 
       subtitle = "Quarterly obseravations") + 
  scale_x_discrete(labels = c('Hostility without war \n (1933 Q2 to 1939 Q3)',
                              'Pact \n (1939 Q4 to 1941 Q2)', 'War \n (1941 Q3 to 1945 Q2)'))


ggsave(here::here("plots/did_effects_quart_window.pdf"))
```


```{r}
min_by_q %>% 
  ggplot(aes(x = year_q_date, y = log_n)) + geom_line() + facet_wrap(~ethnicity) +
  labs(y = "log(1 + y)", x = "year") + theme_bw()

ggsave(here("plots/arrests_by_ethnicity_quart.pdf"), width = 9, height = 6)
```

```{r}
min_by_q %>% 
  ggplot() + geom_line(aes(x = year_q_date, y = log_n, col = ethnicity)) + gghighlight(ethnicity == "German") +
  labs(y = "log(1 + y)", x = "year") +  theme_minimal() + 
  scale_y_continuous(limits = c(0, NA), expand = c(0,0)) +
  theme(axis.line = element_line(size = 0.75))

ggsave(here::here("plots/arrests_by_ethnicity_quart_highlight.pdf"))

```

