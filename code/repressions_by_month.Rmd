---
title: "R Notebook"
output: html_notebook
---

Load the necessary packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(lubridate)
library(stargazer)
library(here)
library(kableExtra)
library(estimatr)
library(multiwayvcov)
```


```{r}
load(here("data/eventsClean_v1.RData"))
```

```{r}
minorities_var_names <- names(events) %>% 
  str_subset("ETHNIC_")
```
We exclude Russians from vector of minorities
```{r}
minorities_var_names <- minorities_var_names[-1] 

```

```{r}
events <- events %>% 
  select(-c(NEAREST_RAIL_ID:LEVEL_SV)) %>% 
  mutate(date_ym = str_c(YEAR,  MONTH, 1, sep = "-"))

```

```{r}
min_by_month <- events %>%
  select(date_ym, ETHNIC_BEL:ETHNIC_CHECHEN) %>% 
  group_by_all() %>% 
  count() %>% 
  ungroup()


write_csv(min_by_month, here("data/min_arrests_by_month.csv"))


```

```{r}
min_by_month <- read_csv(here("data/min_arrests_by_month.csv"))

min_by_month <- min_by_month %>% 
  mutate(n_of_eth_gr = rowSums(.[2:18])) %>% 
  filter(n_of_eth_gr == 1) %>% 
  select(-n_of_eth_gr) %>% 
  gather(key= "ethnicity", value = "value", -c(date_ym, n)) %>% 
  filter(value == 1) %>% 
  select(-value)

```

```{r}
min_by_month <- min_by_month %>% 
  complete(date_ym, ethnicity, fill = list(n = 0)) %>% 
  filter(date_ym >= 1921) %>% 
  mutate(ethnicity = str_remove(ethnicity, "ETHNIC_"), 
         ethnicity = case_when(ethnicity == "BEL" ~ "Belarussian",
                               ethnicity == "GER" ~ "German",
                               ethnicity == "POL" ~ "Polish",
                               ethnicity == "UKR" ~ "Ukrainian",
                               TRUE ~ ethnicity) %>% 
                      str_to_title() %>% 
                      as.factor(),
         log_n = log(n + 1), 
         german = ifelse(ethnicity == "German", 1, 0))

```


```{r}
min_by_month %>% 
  filter(n == 0)
  
```

```{r}
min_by_month <- min_by_month %>% 
  mutate(date = as_date(date_ym)) 
  
```

```{r}
min_by_q <-  min_by_month %>% 
  mutate(year_q = quarter(date, with_year = T),
         year_q_date = floor_date(date, unit = "quarter"),
         year_q_decimal = decimal_date(year_q_date)) %>% 
  group_by(year_q, ethnicity, german) %>% 
  summarize(n = sum(n)) %>% 
  ungroup() %>% 
  mutate(log_n = log(n + 1)) %>% 
  group_by(ethnicity) %>% 
  mutate(t = row_number()) %>% 
  ungroup()
```

```{r}
year_quarters <- crossing(year = 1931:1937, quarter = 1:4) %>% 
  mutate(yq = str_c(year, quarter, sep = ".")) %>% 
  pull(yq)

post_yq_dummies <- map_dfc(year_quarters, ~  as.numeric(min_by_q$year_q >= .)) %>% 
  rename_all( funs( c(paste0("post_" ,year_quarters))))

min_by_q <-bind_cols(min_by_q, post_yq_dummies)

```

```{r}
fmla <- as.formula(paste("log_n ~ ", 
                         paste0("german:","post_", year_quarters, collapse = " + "),  "+ as.factor(year_q) +
                         ethnicity + t:ethnicity"))

diff_model <- lm(fmla,  data = min_by_q)

summary(diff_model)
diff_model_restr <- lm(fmla,  data = filter(min_by_q, year_q <= 1946))
tidy(diff_model_restr)
```

```{r}
library(zoo)
diff_model %>% 
  broom::tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:post_","") %>% 
           str_replace("\\.", " Q") %>% 
           as.yearqtr() %>% 
           as.Date()) %>% 
  ggplot(mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_bw() + scale_x_date(date_minor_breaks = "1 year")+
  labs(x = "year", caption = "error bars show 95% confidence intervals")
ggsave(here("plots/did_effects_quarter.pdf"))
  gather(key = stat_type, value, c(estimate, conf.low, conf.high)) %>% 

```


```{r}
did_effects_quart_line <- diff_model %>% 
  broom::tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:post_","") %>% 
           str_replace("\\.", " Q") %>% 
           as.yearqtr() %>% 
           as.Date()) %>% 
  ggplot(mapping = aes(x = nice_labs))+ 
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "grey70")+
  geom_line(aes(y = estimate), col = "black") +
  theme_bw() +  geom_hline(yintercept= 0, col = "black", linetype = "dashed") +
  scale_x_date(date_minor_breaks = "1 year") + 
  geom_vline(xintercept = ymd(19330101), color = "red") +
  labs(x = "year", caption = "the shaded ares shows 95% confidence intervals",
       title = "Estimates on quarterly interactions of german*post")

ggsave(here("plots/did_effects_quart_line.pdf"), plot = did_effects_quart_line)

```

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
