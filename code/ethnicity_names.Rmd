---
title: "ethnicity_names"
author: "Martin Kos√≠k"
date: "12 ledna 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stringi)
library(here)
library(tidyverse)
library(data.table)
```

## R Markdown

```{r}
load("data/eventsClean_v1.RData")
names(events)
events <- as.data.table(events)
table(events$SOURCE)
str(events)
Sys.setlocale("LC_CTYPE", "russian") 
stri_trans_general(head(events$SOURCE), "russian-latin/bgn")
events$SOURCE_latin <- stri_trans_general(events$SOURCE, "cyrillic-latin")
events$NAME_latin <- stri_trans_general(events$NAME, "russian-latin/bgn")

events <- head(events) %>% 
  mutate(surname = extract2(str_split(NAME, pattern = " ", n = 2))) %>% 
  unnest()

events$surname <-  str_split(events$NAME, pattern = " ", n = 2) %>% 
  map_chr(1)

events$surname_latin <- stri_trans_general(events$surname, "cyrillic-latin")

events %>% 
  filter(ETHNIC_GER == 1) %>% 
  select(NAME, NAME_latin, surname, surname_latin) %>% 
  count(surname, surname_latin, sort = T) %>% 
  write_csv(here("data/german_surnames.csv"))



```

```{r}
german_surnames <- read_csv(here("data/german_surnames.csv"))

ger_surnames_vec <- german_surnames %>% 
  filter(n > 3) %>%
  pull(surname)


rm(german_surnames)  

gc()

events <- events %>% 
  mutate(ger_surname = ifelse(surname %in% ger_surnames_vec, 1, 0))

events <- events %>% 
  select(-c(GULAG_RAILMED:CENT_DEGREE_R))

events <- events %>% 
  left_join(filter(german_surnames, n > 4), c("surname"))

events$ger_surname <- ifelse(is.na(events$n), 0, 1)
```

```{r}
save(events, file = here("data/eventsClean_v2.RData"))
```


```{r}
events %>% 
  filter(!is.na(n)) %>% 
  count(ETHNIC_GER)
```


```{r}
events %>% 
  select(ETHNIC_TA, NAME, NAME_latin) %>% 
  filter(ETHNIC_TATAR == 1) %>% 
  sample_n(1000)
```

```{r}

```

