---
title: "Geopolitics of repression"
author: "Martin Kos√≠k"
date: "1 ledna 2019"
output: github_document
editor_options: 
  chunk_output_type: console
---
Load the necessary packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(stargazer)
library(here)
library(kableExtra)
```


Import the individual arrests data
```{r eval=FALSE}
load("data/eventsClean_v1.RData")
```

We checkout the names out all variables
```{r eval=FALSE}
names(events)

minorities_var_names <- names(events) %>% 
  str_subset("ETHNIC_")

minorities_var_names <- minorities_var_names[-1]
```

We count the number of arrests for each minority by year.
```{r eval=FALSE}
var_enq <- enquo(minorities_var_names)
min_by_year <- events %>%
  select(YEAR, ETHNIC_BEL:ETHNIC_CHECHEN) %>% 
  group_by_all() %>% 
  count() %>% 
  ungroup()
  
write_csv(min_by_year, "min_arrests_by_year.csv")

```


```{r}

  
min_by_year <- read_csv(here("min_arrests_by_year.csv"))

min_by_year <- min_by_year %>% 
  ungroup() %>% 
  mutate(n_of_eth_gr = rowSums(.[2:18])) %>% 
  filter(n_of_eth_gr == 1) %>% 
  select(-n_of_eth_gr) %>% 
  gather(key= "ethnicity", value = "value", -c(YEAR, n)) %>% 
  filter(value == 1) %>% 
  select(-value)

paste(levels(min_by_year$ethnicity), collapse = ", ")

```

```{r}
min_by_year <- min_by_year %>% 
  complete(YEAR, ethnicity, fill = list(n = 0)) %>% 
  filter(YEAR >= 1923) %>% 
  mutate(ethnicity = str_remove(ethnicity, "ETHNIC_"), 
         ethnicity = case_when(ethnicity == "BEL" ~ "Belarussian",
                               ethnicity == "GER" ~ "German",
                               ethnicity == "POL" ~ "Polish",
                               ethnicity == "UKR" ~ "Ukrainian",
                               TRUE ~ ethnicity) %>% 
                      str_to_title() %>% 
                      as.factor(),
         log_n = log(n + 1), 
         GER = ifelse(ethnicity == "German", 1, 0))


```

Some summary statstics
```{r}
 min_by_year %>% 
  group_by(ethnicity) %>% 
  summarize(Arrests = sum(n)) %>% 
  kable("latex", booktabs = T, caption = "Total arrest by ethnicity, 1923-1953", 
        col.names = c("Ethnicity", "Number of arrests")) %>% 
  write_file( "total_arrests_tab.tex")

  
```


```{r}
years <- 1928:1936

post_year_dummies <- map_dfc(years, ~  as.numeric(min_by_year$YEAR >= .)) %>% 
  rename_all( funs( c(paste0("post_" ,years))))

min_by_year <-bind_cols(min_by_year, post_year_dummies)
```


We create the formula 
```{r}
fmla <- as.formula(paste("log_n ~ ", 
                         paste0("post_", years, ":GER", collapse = " + "),  "+ as.factor(YEAR) + ethnicity"))

summary(lm(fmla,  data = min_by_year))

fmla_simple <- as.formula(paste("log_n ~ ", 
                         paste0("post_", years, ":GER", collapse = " + "),  "+ as.factor(YEAR) + GER"))

summary(lm(fmla_simple,  data = min_by_year))

```


```{r}
min_by_year %>% 
  ggplot(aes(x = YEAR, y = log_n)) + geom_line() + facet_wrap(~ethnicity, scales = "free") + theme_bw()
```

