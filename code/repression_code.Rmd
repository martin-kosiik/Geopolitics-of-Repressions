---
title: "Geopolitics of repression"
author: "Martin Kos√≠k"
date: "1 ledna 2019"
output: github_document
editor_options: 
  chunk_output_type: console
---
Load the necessary packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(stargazer)
library(here)
library(kableExtra)
library(estimatr)
```


Import the individual arrests data
```{r eval=FALSE}
load("data/eventsClean_v1.RData")
```

We checkout the names out all variables
```{r eval=FALSE}
names(events)

minorities_var_names <- names(events) %>% 
  str_subset("ETHNIC_")

minorities_var_names <- minorities_var_names[-1]
```

We count the number of arrests for each minority by year.
```{r eval=FALSE}
var_enq <- enquo(minorities_var_names)
min_by_year <- events %>%
  select(YEAR, ETHNIC_BEL:ETHNIC_CHECHEN) %>% 
  group_by_all() %>% 
  count() %>% 
  ungroup()
  
write_csv(min_by_year, "min_arrests_by_year.csv")

```


```{r}

  
min_by_year <- read_csv(here("min_arrests_by_year.csv"))

min_by_year <- min_by_year %>% 
  ungroup() %>% 
  mutate(n_of_eth_gr = rowSums(.[2:18])) %>% 
  filter(n_of_eth_gr == 1) %>% 
  select(-n_of_eth_gr) %>% 
  gather(key= "ethnicity", value = "value", -c(YEAR, n)) %>% 
  filter(value == 1) %>% 
  select(-value)

paste(levels(min_by_year$ethnicity), collapse = ", ")

```

```{r}
min_by_year <- min_by_year %>% 
  complete(YEAR, ethnicity, fill = list(n = 0)) %>% 
  filter(YEAR >= 1921) %>% 
  mutate(ethnicity = str_remove(ethnicity, "ETHNIC_"), 
         ethnicity = case_when(ethnicity == "BEL" ~ "Belarussian",
                               ethnicity == "GER" ~ "German",
                               ethnicity == "POL" ~ "Polish",
                               ethnicity == "UKR" ~ "Ukrainian",
                               TRUE ~ ethnicity) %>% 
                      str_to_title() %>% 
                      as.factor(),
         log_n = log(n + 1), 
         german = ifelse(ethnicity == "German", 1, 0))


```

Some summary statstics
```{r}
 min_by_year %>% 
  group_by(ethnicity) %>% 
  summarize(Arrests = sum(n)) %>% 
  kable("latex", booktabs = T, caption = "Total arrest by ethnicity, 1921-1958", 
        col.names = c("Ethnicity", "Number of arrests")) %>% 
  write_file("tables/total_arrests_tab.tex")

  
```


```{r}
years <- 1930:1938

post_year_dummies <- map_dfc(years, ~  as.numeric(min_by_year$YEAR >= .)) %>% 
  rename_all( funs( c(paste0("post_" ,years))))

min_by_year <-bind_cols(min_by_year, post_year_dummies)
```


We create the formula 
```{r}
fmla <- as.formula(paste("log_n ~ ", 
                         paste0("german:","post_", years, collapse = " + "),  "+ as.factor(YEAR) + ethnicity"))

diff_model <- lm(fmla,  data = min_by_year)
lm_robust(fmla, clusters = min_by_year$ethnicity , data = min_by_year, se_type = "stata")

diff_model_restr <- lm(fmla,  data = filter(min_by_year, YEAR <= 1945))

summary(diff_model)
fmla_no_log <- as.formula(paste("n ~ ", 
                         paste0("german:","post_", years, collapse = " + "),  "+ as.factor(YEAR) + ethnicity"))
diff_model_no_log <- lm(fmla_no_log,  data = min_by_year)

```

```{r}
var_labels <- str_c("$",names(diff_model$coefficients)) %>% 
  str_subset("german:post_") %>% 
  str_replace_all("t", "t\\\\") %>% 
  str_replace(":", "*") %>% 
  str_c("$")

cat(var_labels)
cov1         <- vcovHC(output, type = "HC1")
robust_se    <- sqrt(diag(cov1))
coef_test(diff_model, vcov = "CR2", 
          cluster = min_by_year$ethnicity, test = "Satterthwaite")


diff_model_robust <- commarobust(diff_model, clusters = min_by_year$ethnicity, se_type = "stata")
diff_model_restr_robust <- commarobust(diff_model_restr,
                                       clusters = filter(min_by_year, YEAR <= 1945)$ethnicity, se_type = "stata")
diff_model_no_log_robust <- commarobust(diff_model_no_log, clusters = min_by_year$ethnicity, se_type = "stata")


stargazer(diff_model, diff_model_restr,diff_model_no_log,
          se = starprep(diff_model_robust, diff_model_restr_robust, diff_model_no_log_robust),
          p = starprep(diff_model_robust, diff_model_restr_robust, diff_model_no_log_robust, stat = "p.value"),
          keep = "german:post_+", omit.stat = c("ser", "f"), label = "dif_table",
          covariate.labels = var_labels, title = "Difference-in-difference results",
          dep.var.labels = c("$\\log(1 + y_{it})$", "$y_{it}$"), 
          add.lines = list(c("Year dummies", "Yes", "Yes", "Yes"),
                           c("Ethnicity dummies", "Yes", "Yes", "Yes")),
          column.labels = c("1921-1958", "1921-1945", "1921-1958")) %>% 
 cat(sep = '\n', file = here("tables/diff_table.tex"))
```


```{r}
diff_model %>% 
  tidy(conf.int = TRUE) %>% 
  filter(str_detect(term, "german:")) %>% 
  mutate(nice_labs = str_replace(term,"german:post_","")) %>% 
  ggplot(mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_bw() + 
  labs(x = "year", caption = "error bars show 95% confidence intervals")

ggsave(here("plots/did_effects.pdf"))
  
```

```{r}
out_comp <- tidy(lm(fmla,  data = by_year),  conf.int = TRUE) %>% 
  filter(str_detect(term, "ETHNIC_GER:")) %>% 
  mutate(nice_labs = str_replace(term,"ETHNIC_GER:v_",""))
out_comp 
ggplot(out_comp, mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_bw() + labs(x = "year", title = "Estimates ")

ggsave("did_all.pdf")
```


```{r}
min_by_year %>% 
  ggplot(aes(x = YEAR, y = log_n)) + geom_line() + facet_wrap(~ethnicity) +
  labs(y = "log(1 + y)", x = "year") + theme_bw()

ggsave(here("plots/arrests_by_ethnicity.pdf"))
```

