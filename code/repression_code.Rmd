---
title: "Geopolitics of repression"
author: "Martin Kos√≠k"
date: "1 ledna 2019"
output: github_document
editor_options: 
  chunk_output_type: console
---
Load the necessary packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(stargazer)
library(here)
library(readxl)
library(knitr)
library(kableExtra)
library(estimatr)
library(gghighlight)
library(lubridate)
library(clubSandwich)
#library(cowplot)
```

Import the  data

```{r}
ethnicity_controls <- read_excel(here::here("data/ethnicity_info.xlsx")) %>%
  mutate(ethnicity_id = as.numeric(1:n()),
         urb_rate_pct = urb_rate * 100)
  
min_by_year <-  read_csv(here::here("data/min_by_year_preds.csv")) %>% 
  mutate(log_n = log(1 + label ),
         log_n_pred_full = log(1 + label + pred_adj_full_scaled),
         log_n_pred = log(1 + label + prediction),
         log_n_imp_date = log(1 + label_imp_date),
         log_n_pred_full_imp_date = log(1 + label_imp_date + pred_adj_full_scaled_imp_date),
         n_pred_full_imp_date =  label_imp_date + pred_adj_full_scaled_imp_date,
         log_n_pred_full_imp_date_rehab = log(1 + label_rehab + pred_adj_full_scaled_rehab),
         log_n_pred_pars_imp_date = log(1 + label_imp_date + pred_adj_scaled_imp_date),
         log_n_pred_imp_date = log(1 + label_imp_date + prediction_imp_date)) %>% 
  left_join(ethnicity_controls, by = "ethnicity") %>% 
  mutate(german = ifelse(ethnicity == "German", 1, 0),
         post_german = german * ifelse(YEAR >= 1933, 1, 0),
         ethnicity = as.factor(ethnicity),
         YEAR_sq = YEAR^2, 
         pre_treatment = ifelse(YEAR >= 1922 & YEAR < 1933, 1, 0),
         hostility = ifelse(YEAR >= 1933 & YEAR <= 1939, 1, 0), 
         pact = ifelse(YEAR > 1939 & YEAR < 1941, 1, 0), 
         war = ifelse(YEAR >= 1941 & YEAR < 1945, 1, 0),
         post_war = ifelse(YEAR >= 1945, 1, 0)) 
```



```{r}
min_by_year <- min_by_year %>% 
  mutate(geopol_finnish_war = as.numeric(YEAR >= 1939 & YEAR < 1945 & (ethnicity == "Finnish")),
         geopol_finnish_postwar = as.numeric(YEAR >=  1945 & (ethnicity == "Finnish")),
         geopol_baltic_anex = as.numeric(YEAR == 1940 & (ethnicity %in% c("Estonian", "Latvian", "Lithuanian"))),
         geopol_baltic_nazi = as.numeric(YEAR >= 1941 & YEAR <= 1943 &
                                           (ethnicity %in% c("Estonian", "Latvian", "Lithuanian"))),
         geopol_baltic_postwar = as.numeric(YEAR >= 1944 & 
                                           (ethnicity %in% c("Estonian", "Latvian", "Lithuanian"))),
         geopol_polish_war = as.numeric(YEAR == 1939 & (ethnicity == "Polish")),
         geopol_polish_soviet = as.numeric(YEAR == 1940 & (ethnicity  == "Polish")),
         geopol_polish_nazi = as.numeric(YEAR >= 1941 & YEAR < 1945 & (ethnicity == "Polish")),
         geopol_polish_postwar = as.numeric(YEAR >=  1945 & (ethnicity == "Polish")),
         geopol_japnese_war = as.numeric(YEAR >= 1938 & YEAR <= 1939 &  (ethnicity == "Japanese")),
         geopol_japnese_neutrality = as.numeric(YEAR >= 1938 & YEAR <= 1944 &  (ethnicity == "Japanese")),
         geopol_japnese_ww2 = as.numeric(YEAR == 1945 &  (ethnicity == "Japanese")),
         geopol_japnese_postwar = as.numeric(YEAR > 1945 &  (ethnicity == "Japanese")),
         geopol_hungarian_war = as.numeric(YEAR >= 1941 & YEAR < 1945 & (ethnicity == "Hungarian")),
         geopol_hungarian_postwar = as.numeric(YEAR >=  1945 & (ethnicity == "Hungarian")))
```


```{r}
years <- 1922:1960

year_dummies <- map_dfc(years, ~  if (dplyr::last(years) == .){
                                                    as.numeric(min_by_year$YEAR >= .)} else {
                                                    as.numeric(min_by_year$YEAR == .)}) %>% 
  rename_all(funs( c(paste0("year_" ,years))))

min_by_year <- bind_cols(min_by_year, year_dummies)
```

```{r}
ethnicities <- setdiff(levels(min_by_year$ethnicity), "Yakut")

ethnicity_dummies <- map_dfc(ethnicities, ~ ifelse(as.numeric(min_by_year$ethnicity == .), 1, 0)) %>% 
  rename_all(funs( c(paste0("ethnicity_" ,ethnicities))))
  

min_by_year <- bind_cols(min_by_year, ethnicity_dummies)

```

We create the formulas and fit the models

```{r}
geopol_vars <- str_subset(names(min_by_year), "geopol")

fmla_pred_full_imp_date_lin_trends_geopol <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR +", paste0(geopol_vars, collapse = " + ")))

fmla_pred_full_imp_date_geopol <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR+ ethnicity: YEAR_sq + ",  paste0(geopol_vars, collapse = " + ")))


fmla_pred_full_imp_date_no_trends_geopol <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity+ ",  paste0(geopol_vars, collapse = " + ")))
```

```{r}
geopol_vars <- str_subset(names(min_by_year), "geopol")

fmla_pred_full_imp_date_lin_trends_geopol_rehab <- as.formula(paste("log_n_pred_full_imp_date_rehab ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR +", paste0(geopol_vars, collapse = " + ")))

fmla_pred_full_imp_date_geopol_rehab <- as.formula(paste("log_n_pred_full_imp_date_rehab ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR+ ethnicity: YEAR_sq + ",  paste0(geopol_vars, collapse = " + ")))


fmla_pred_full_imp_date_no_trends_geopol_rehab <- as.formula(paste("log_n_pred_full_imp_date_rehab ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity+ ",  paste0(geopol_vars, collapse = " + ")))
```

```{r}
fmla_pred_full_imp_date_lin_trends <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR"))

fmla_pred_full_imp_date <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity + ethnicity: YEAR+ ethnicity: YEAR_sq"))


fmla_pred_full_imp_date_no_trends <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity"))
```


```{r labeled data}
plot_effects_robust_se <- function(data = min_by_year, formula = fmla, vcov = "CR2", level = 0.95){
  model <- lm(formula,  data = data)
  model %>% 
  conf_int(vcov = vcov,  level = level,
          cluster = data$ethnicity,  test = "Satterthwaite") %>% 
  as_tibble(rownames = "term") %>% 
  filter(str_detect(term, "german:")) %>% 
  rename(conf.low = CI_L, conf.high = CI_U, estimate = beta) %>% 
  mutate(nice_labs = str_replace(term,"german:year_","")
         #, nice_labs = as.numeric(nice_labs)
         #,nice_labs = ifelse(as.numeric(nice_labs)== max(as.numeric(nice_labs)), str_c(nice_labs, "+"), nice_labs)
         )%>% 
  ggplot(mapping = aes(x = nice_labs, y = estimate, ymin = conf.low, ymax = conf.high, group = 1))+ 
    # geom_vline(xintercept= 1933, col = "red", linetype = "dashed", size = 1)+
  geom_pointrange()+  geom_hline(yintercept= 0) + theme_minimal() + 
  theme(axis.line = element_line(size = 1), 
        panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), 
        text = element_text(size=14),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "Year", 
        #caption = "error bars show 95% confidence intervals \n 
         #                      SE are based on the cluster-robust estimator by Pustejovsky and Tipton (2018)", 
       y = "Coefficient")
}


plot_effects_robust_se() #+ theme(axis.text.x = element_text(angle = 60, hjust = 1))
ggsave(here::here("plots/effects/annual/point_range_robust_cr2.pdf"))
  
plot_effects_robust_se(vcov = "CR0")
ggsave(here::here("plots/effects/annual/point_range_robust_cr0.pdf"))


plot_effects_robust_se(formula =  fmla_pred_full) #+ theme(axis.text.x = element_text(angle = 60 , hjust = 1))
ggsave(here::here("plots/effects/ethnicity_imputation/annual/point_range_robust_cr2.pdf"))

plot_effects_robust_se(formula =  fmla_pred_full_imp_date_no_trends)

ggsave(here::here("plots/effects/ethnicity_imputation/annual/pr_cr2_date_imp_full_years_no_trends.pdf"))

plot_effects_robust_se(data = min_by_year, formula =  fmla_pred_full_imp_date_lin_trends)

ggsave(here::here("plots/effects/ethnicity_imputation/annual/pr_cr2_date_imp_full_years_lin_trends.pdf"))


plot_effects_robust_se(formula = fmla_pred_full_imp_date)+theme(axis.text.x = element_text(angle = 60 , hjust = 1))
ggsave(here::here("plots/effects/ethnicity_imputation/annual/point_range_robust_cr2_date_imp.pdf"))
ggsave(here::here("plots/effects/ethnicity_imputation/annual/point_range_robust_cr2_date_imp_full_years.pdf"))


plot_effects_robust_se(formula = fmla_imp_date) +theme(axis.text.x = element_text(angle = 90 , hjust = 1))
ggsave(here::here("plots/effects/annual/point_range_robust_cr2_date_imp.pdf"))

plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends)

```


```{r}
plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends_geopol)
ggsave(here::here("plots/final/fmla_pred_full_imp_date_no_trends_geopol_cr2.pdf"))

plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends_geopol, vcov = "CR0")
ggsave(here::here("plots/final/fmla_pred_full_imp_date_no_trends_geopol_cr0.pdf"))


plot_effects_robust_se(formula = fmla_pred_full_imp_date_lin_trends_geopol)
plot_effects_robust_se(formula = fmla_pred_full_imp_date_geopol)

plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends_geopol_rehab)
ggsave(here::here("plots/final/fmla_pred_full_imp_date_no_trends_geopol_rehab_cr2.pdf"))
plot_effects_robust_se(formula = fmla_pred_full_imp_date_lin_trends_geopol_rehab)
plot_effects_robust_se(formula = fmla_pred_full_imp_date_geopol_rehab)



min_by_year %>% 
  lm(formula = fmla_pred_full_imp_date_geopol) %>% 
  broom::augment() %>% 
  filter(german == 1) %>% 
  dplyr::select(.resid) %>% 
  View()

min_by_year %>% 
  lm(formula = fmla_pred_full_imp_date_geopol) %>% 
  broom::augment() %>% 
  filter(german == 1) %>% 
  dplyr::select(.resid) %>% 
  mutate(YEAR = 1920 + row_number()) %>% 
  ggplot(aes(x = YEAR, y = .resid)) + geom_point()
```


```{r}

years_from_1933 <- 1933:1960
years_from_1927 <- 1927:1960

fmla_pred_full_imp_date_no_trends_geopol_from_1933 <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years_from_1933, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity+ ",  paste0(geopol_vars, collapse = " + ")))


fmla_pred_full_imp_date_no_trends_geopol_from_1927 <- as.formula(paste("log_n_pred_full_imp_date ~ ", 
                         paste0("german:","year_", years_from_1927, collapse = " + "),  "+ as.factor(YEAR) +
                         ethnicity+ ",  paste0(geopol_vars, collapse = " + ")))


plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends_geopol_from_1933)+
  theme(axis.text.x = element_text(angle = 60 , hjust = 1))
ggsave(here::here("plots/final/pred_full_imp_date_no_trends_geopol_cr2_base_1933.pdf"))

plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends_geopol_from_1927)+
  theme(axis.text.x = element_text(angle = 60 , hjust = 1))
ggsave(here::here("plots/final/pred_full_imp_date_no_trends_geopol_cr2_base_1927.pdf"))


```


```{r}
min_by_year %>% 
  filter(ind_country == 1) %>% 
  plot_effects_robust_se(formula = fmla_pred_full_imp_date) 
ggsave(here::here("plots/effects/ethnicity_imputation/annual/pr_cr2_date_imp_full_years_ind_country.pdf"))



 min_by_year %>% 
  filter(ind_country == 0 | ethnicity == "German") %>% 
  plot_effects_robust_se(formula = fmla_pred_full_imp_date_no_trends)
 ggsave(here::here("plots/final/pr_cr2_date_imp_full_years_no_trends_not_ind_country.pdf"))

```


```{r}
quadratic_terms <-  min_by_year %>% 
  filter(YEAR < 1940)  %>% 
  lm_robust(formula = fmla, clusters = ethnicity, se_type = "CR2") %>% 
  summary()
  estimatr::tidy() %>% 
  filter(str_detect(term, ":YEAR") | str_detect(term, "YEAR_sq")) %>% 
  mutate(parameter = ifelse(str_detect(term, ":YEAR_sq"), "b", "a"),
         term = str_extract(term, "_[:alpha:]+\\:") %>% 
           str_replace_all("_|\\:", "")) %>% 
  dplyr::select(term, estimate, parameter) %>% 
  spread(key = parameter, value = estimate)
  

min_by_year %>% 
  filter(YEAR < 1940) %>% 
  left_join(quadratic_terms, by = c("ethnicity" = "term")) %>% 
  mutate(predicted = a * (YEAR - 1920) + b * (YEAR - 1920)^2) %>% 
  ggplot(aes(x = YEAR, y = predicted)) + geom_line() + facet_wrap(~ethnicity) +
  labs(y = "log(1 + arrests)", x = "Year") + theme_bw()

ggsave(here::here("plots/arrests_by_ethnicity.pdf"))
```

```{r}
min_by_year %>% 
  ggplot() + geom_line(aes(x = YEAR, y = log_n, col = ethnicity)) + gghighlight(ethnicity == "German") +
  labs(y = "log(1 + arrests)", x = "Year") + theme_bw()

ggsave(here::here("plots/arrests_by_ethnicity_highlight.pdf"))

```
