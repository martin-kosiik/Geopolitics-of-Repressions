---
title: "Naive bayes"
author: "Martin Kosík"
date: "8 února 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(data.table)
library(lubridate)
library(stargazer)
library(here)
library(kableExtra)
library(estimatr)
library(multiwayvcov)
library(caret)
library(naivebayes)
library(bnclassify)
library(h2o)
library(klaR)
library(rsample)
```


```{r }
Sys.setlocale("LC_CTYPE", "russian") 


load("data/eventsClean_v1.RData")

```

We filter out those wtih multiple ethnicities
```{r}
events <- events %>% 
  mutate(n_of_eth_gr = rowSums(.[37:54]))

events %>% 
  count(n_of_eth_gr, sort = T)

events <- events %>% 
  filter(n_of_eth_gr == 1)

```

```{r}

minorities_var_names <- names(events) %>% 
  str_subset("ETHNIC_")

events <- as.data.table(events)

events_long <- melt(events, id.vars = "AID",
                measure.vars = minorities_var_names, 
                variable.name = "ethnicity")[
                  value == 1][,ethnicity := str_remove(ethnicity, "ETHNIC_")][,
                    ethnicity :=  case_when(ethnicity == "BEL" ~ "Belarussian",
                                            ethnicity == "RUS" ~ "Russian",
                               ethnicity == "GER" ~ "German",
                               ethnicity == "POL" ~ "Polish",
                               ethnicity == "UKR" ~ "Ukrainian",
                               TRUE ~ ethnicity) %>% 
                      str_to_title()][, value := NULL]

events <- events[events_long, on = "AID"]

rm(events_long)
gc()

```

```{r}
events <- events %>% 
  dplyr::select(AID, NAME, ethnicity)

events <- events %>% 
  mutate(names_split = str_split(NAME, pattern = " "),
         first_name = as.factor(map_chr(names_split, last)),
         surname = as.factor(map_chr(names_split, 1)),
         number_of_names = as.factor(map_int(names_split, length)),
         ethnicity = as.factor(ethnicity))

class(events$ethnicity)
head(events)

events %>% 
  count(number_of_names, sort = T)

```

```{r}

split <- initial_split(events, prop = .85, strata = "ethnicity")
train <- training(split)
test  <- testing(split)

```


```{r}
# create response and feature data
x <- train[, c("surname", "first_name")]
y <- train$ethnicity

# set up 10-fold cross validation procedure
train_control <- trainControl(
  method = "cv", 
  number = 5
  )

table(y)
# train model
nb.m1 <- train(
  x = x,
  y = y,
  method = "nb",
  trControl = train_control
  )

# results
confusionMatrix(nb.m1)

confusionMatrix(predict(nb.m1, test), test$ethnicity)

flat_prior <- rep(1/18, 18)

nb_flat_prior <- naive_bayes(ethnicity ~ surname + first_name + number_of_names, data = train, 
                             laplace = 1, usekernel = FALSE)

nb_klaR <- NaiveBayes(ethnicity ~ surname + first_name + number_of_names, data = train, 
                             fL = 1, usekernel = FALSE)

nb_e <- naiveBayes(ethnicity ~ surname + first_name + number_of_names, data = train, 
                             fL = 1, usekernel = FALSE)
h2o.init()

train_h2o <- as.h2o(train[, -4])

nb_h2o <- h2o.naiveBayes(y = 3, x = 4:6, training_frame = train_h2o, laplace = 1)

?h2o.naiveBayes
str(train)

confusionMatrix(predict(nb_flat_prior), train$ethnicity)
confusionMatrix(predict(nb_e, train), train$ethnicity)


head(predict(nb_flat_prior))

confusionMatrix(predict(nb_klaR, test)$class, test$ethnicity)

length(nb_flat_prior$levels)
nb_flat_prior$prior

predict(nb_flat_prior, newdata = test)
head(predict(nb_flat_prior, type = "class"))
str(train)

browseVignettes("bnclassify")
nb <- nb('ethnicity', dataset = dplyr::select(train,ethnicity,  surname, first_name, number_of_names) , features = c("surname", "first_name", "number_of_names")) # Learn a naive Bayes structure
nb <- lp(nb, dplyr::select(train,ethnicity,  surname, first_name, number_of_names), smooth = 1) # Learn parameters 
cv(nb, dplyr::select(train,ethnicity,  surname, first_name, number_of_names), k = 4) # 10-fold Cross-validation estimate of accuracy 
head(predict(nb, dplyr::select(test,ethnicity,  surname, first_name, number_of_names)))

confusionMatrix(predict(nb, dplyr::select(test,ethnicity,  surname, first_name, number_of_names)), test$ethnicity)
confusionMatrix(predict(nb, dplyr::select(train,ethnicity,  surname, first_name, number_of_names)), train$ethnicity)

                
save(nb.m1, file = "nb_model")
```

